generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String         @id @default(cuid())
  email               String         @unique
  password            String
  role                UserRole
  name                String?
  active              Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  emailVerified       Boolean        @default(false)
  emailVerifyExpiry   DateTime?
  emailVerifyToken    String?
  passwordResetExpiry DateTime?
  passwordResetToken  String?
  notifications       Notification[]
  partners            Partner[]

  @@index([email])
  @@index([role])
  @@index([emailVerifyToken])
  @@index([passwordResetToken])
}

model Partner {
  id                  String        @id @default(cuid())
  userId              String
  companyName         String?
  active              Boolean       @default(true)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  userType            String?
  onboardingCompleted Boolean       @default(false)
  onboardingStep      Int           @default(0)
  apps                App[]
  invoices            Invoice[]
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription        Subscription?
  teamMembers         TeamMember[]

  @@index([userId])
}

model App {
  id           String        @id @default(cuid())
  name         String
  apiKey       String        @unique
  partnerId    String
  monthlyLimit Int           @default(10000)
  currentUsage Int           @default(0)
  status       AppStatus     @default(ACTIVE)
  isSandbox    Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  apiUsageLogs ApiUsageLog[]
  partner      Partner       @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  campaigns    Campaign[]
  fraudFlags   FraudFlag[]
  webhooks     Webhook[]

  @@index([partnerId])
  @@index([apiKey])
  @@index([status])
}

model Campaign {
  id                String         @id @default(cuid())
  appId             String
  name              String
  status            CampaignStatus @default(ACTIVE)
  referralType      ReferralType
  rewardModel       RewardModel
  rewardValue       Float
  rewardCap         Float?
  firstTimeUserOnly Boolean        @default(true)
  startDate         DateTime?
  endDate           DateTime?
  conversionWindow  Int?
  rewardExpiration  Int?
  level1Reward      Float?
  level2Reward      Float?
  level1Cap         Float?
  level2Cap         Float?
  tierConfig        String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  app               App            @relation(fields: [appId], references: [id], onDelete: Cascade)
  referrals         Referral[]

  @@index([appId])
  @@index([status])
}

model Referral {
  id               String         @id @default(cuid())
  campaignId       String
  referralCode     String         @unique
  referrerId       String
  refereeId        String?
  status           ReferralStatus @default(PENDING)
  clickedAt        DateTime?
  convertedAt      DateTime?
  rewardAmount     Float?
  level            Int            @default(1)
  parentReferralId String?
  ipAddress        String?
  isFlagged        Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  conversions      Conversion[]
  campaign         Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  parentReferral   Referral?      @relation("ReferralHierarchy", fields: [parentReferralId], references: [id])
  childReferrals   Referral[]     @relation("ReferralHierarchy")

  @@index([campaignId])
  @@index([referralCode])
  @@index([referrerId])
  @@index([refereeId])
  @@index([status])
  @@index([parentReferralId])
  @@index([ipAddress])
  @@index([status, campaignId])
}

model Conversion {
  id         String   @id @default(cuid())
  referralId String
  amount     Float?
  metadata   String?
  createdAt  DateTime @default(now())
  referral   Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([referralId])
  @@index([createdAt])
}

model ApiUsageLog {
  id        String   @id @default(cuid())
  appId     String
  endpoint  String
  timestamp DateTime @default(now())
  ipAddress String?
  userAgent String?
  app       App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([timestamp])
}

model PricingPlan {
  id            String         @id @default(cuid())
  name          String
  type          PlanType       @unique
  monthlyPrice  Float
  yearlyPrice   Float?
  apiLimit      Int
  maxApps       Int
  overagePrice  Float
  features      String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]

  @@index([type])
}

model Subscription {
  id                   String             @id @default(cuid())
  partnerId            String             @unique
  planId               String
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  stripeCustomerId     String?
  stripeSubscriptionId String?
  cancelAtPeriodEnd    Boolean            @default(false)
  trialEndsAt          DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  partner              Partner            @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  plan                 PricingPlan        @relation(fields: [planId], references: [id])

  @@index([partnerId])
  @@index([planId])
  @@index([status])
}

model Invoice {
  id                 String    @id @default(cuid())
  partnerId          String
  amount             Float
  currency           String    @default("USD")
  status             String
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime
  apiUsage           Int
  overageAmount      Float     @default(0)
  stripeInvoiceId    String?
  paidAt             DateTime?
  createdAt          DateTime  @default(now())
  partner            Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([status])
  @@index([createdAt])
}

model Webhook {
  id         String            @id @default(cuid())
  appId      String
  url        String
  secret     String
  events     String
  isActive   Boolean           @default(true)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  app        App               @relation(fields: [appId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([appId])
}

model WebhookDelivery {
  id          String           @id @default(cuid())
  webhookId   String
  eventType   WebhookEventType
  payload     String
  response    String?
  statusCode  Int?
  success     Boolean          @default(false)
  retryCount  Int              @default(0)
  nextRetryAt DateTime?
  createdAt   DateTime         @default(now())
  webhook     Webhook          @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([success])
  @@index([nextRetryAt])
}

model TeamMember {
  id               String    @id @default(cuid())
  partnerId        String
  email            String
  name             String?
  role             TeamRole
  inviteToken      String?   @unique
  inviteAcceptedAt DateTime?
  lastLoginAt      DateTime?
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  partner          Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, email])
  @@index([partnerId])
  @@index([email])
}

model FraudFlag {
  id           String    @id @default(cuid())
  appId        String
  referralCode String
  fraudType    FraudType
  description  String
  metadata     String?
  isResolved   Boolean   @default(false)
  resolvedBy   String?
  resolvedAt   DateTime?
  createdAt    DateTime  @default(now())
  app          App       @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([referralCode])
  @@index([isResolved])
  @@index([fraudType])
}

model FeatureFlag {
  id             String   @id @default(cuid())
  key            String   @unique
  name           String
  description    String?
  isEnabled      Boolean  @default(false)
  rolloutPercent Int      @default(0)
  targetPartners String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([key])
  @@index([isEnabled])
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String
  message   String
  source    String?
  metadata  String?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([source])
  @@index([createdAt])
}

model Notification {
  id        String             @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  metadata  String?
  status    NotificationStatus @default(UNREAD)
  readAt    DateTime?
  createdAt DateTime           @default(now())
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model EmailLog {
  id        String    @id @default(cuid())
  to        String
  subject   String
  template  String
  status    String
  error     String?
  metadata  String?
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([to])
  @@index([status])
  @@index([template])
  @@index([createdAt])
}

enum UserRole {
  SUPER_ADMIN
  PARTNER
}

enum AppStatus {
  ACTIVE
  SUSPENDED
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  SCHEDULED
  EXPIRED
}

enum ReferralType {
  ONE_SIDED
  TWO_SIDED
  MULTI_LEVEL
}

enum RewardModel {
  FIXED_CURRENCY
  PERCENTAGE
  TIERED
}

enum ReferralStatus {
  PENDING
  CLICKED
  CONVERTED
  EXPIRED
  FLAGGED
}

enum PlanType {
  FREE
  GROWTH
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum WebhookEventType {
  REFERRAL_CREATED
  REFERRAL_CLICKED
  REFERRAL_CONVERTED
  REWARD_CREATED
  USAGE_LIMIT_EXCEEDED
}

enum TeamRole {
  ADMIN
  ANALYST
  DEVELOPER
}

enum FraudType {
  DUPLICATE_IP
  SELF_REFERRAL
  RATE_LIMIT_EXCEEDED
  SUSPICIOUS_PATTERN
}

enum NotificationType {
  REFERRAL_CONVERTED
  REFERRAL_CODE_GENERATED
  TEAM_INVITE_ACCEPTED
  CUSTOM_ADMIN
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}
