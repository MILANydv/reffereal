generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model ApiUsageLog {
  id        String   @id @default(cuid())
  appId     String
  endpoint  String
  timestamp DateTime @default(now())
  ipAddress String?
  userAgent String?
  App       App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([timestamp])
}

model App {
  id           String        @id @default(cuid())
  name         String
  apiKey       String        @unique
  partnerId    String
  monthlyLimit Int           @default(10000)
  currentUsage Int           @default(0)
  status       AppStatus     @default(ACTIVE)
  isSandbox    Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  fraudConfig  String?
  ApiUsageLog  ApiUsageLog[]
  Partner      Partner       @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  Campaign     Campaign[]
  FraudFlag    FraudFlag[]
  Webhook      Webhook[]

  @@index([apiKey])
  @@index([partnerId])
  @@index([status])
}

model Campaign {
  id                String         @id @default(cuid())
  appId             String
  name              String
  status            CampaignStatus @default(ACTIVE)
  referralType      ReferralType
  rewardModel       RewardModel
  rewardValue       Float
  rewardCap         Float?
  firstTimeUserOnly Boolean        @default(true)
  startDate         DateTime?
  endDate           DateTime?
  conversionWindow  Int?
  rewardExpiration  Int?
  level1Reward      Float?
  level2Reward      Float?
  level1Cap         Float?
  level2Cap         Float?
  tierConfig        String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  App               App            @relation(fields: [appId], references: [id], onDelete: Cascade)
  Referral          Referral[]

  @@index([appId])
  @@index([status])
}

model Conversion {
  id         String   @id @default(cuid())
  referralId String
  amount     Float?
  metadata   String?
  createdAt  DateTime @default(now())
  Referral   Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([referralId])
}

model EmailLog {
  id        String    @id @default(cuid())
  to        String
  subject   String
  template  String
  status    String
  error     String?
  metadata  String?
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([createdAt])
  @@index([status])
  @@index([template])
  @@index([to])
}

model FeatureFlag {
  id             String   @id @default(cuid())
  key            String   @unique
  name           String
  description    String?
  isEnabled      Boolean  @default(false)
  rolloutPercent Int      @default(0)
  targetPartners String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([isEnabled])
  @@index([key])
}

model FraudFlag {
  id           String    @id @default(cuid())
  appId        String
  referralCode String
  fraudType    FraudType
  description  String
  metadata     String?
  isResolved   Boolean   @default(false)
  resolvedBy   String?
  resolvedAt   DateTime?
  flaggedBy    String?
  isManual     Boolean   @default(false)
  createdAt    DateTime  @default(now())
  App          App       @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([referralCode])
  @@index([isResolved])
  @@index([fraudType])
  @@index([isManual])
  @@index([createdAt])
}

model Invoice {
  id                 String    @id @default(cuid())
  partnerId          String
  amount             Float
  currency           String    @default("USD")
  status             String
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime
  apiUsage           Int
  overageAmount      Float     @default(0)
  stripeInvoiceId    String?
  paidAt             DateTime?
  createdAt          DateTime  @default(now())
  Partner            Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([partnerId])
  @@index([status])
}

model Notification {
  id        String             @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  metadata  String?
  status    NotificationStatus @default(UNREAD)
  readAt    DateTime?
  createdAt DateTime           @default(now())
  User      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([type])
  @@index([userId])
}

model Partner {
  id                  String        @id @default(cuid())
  userId              String
  companyName         String?
  active              Boolean       @default(true)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  userType            String?
  onboardingCompleted Boolean       @default(false)
  onboardingStep      Int           @default(0)
  App                 App[]
  Invoice             Invoice[]
  User                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  Subscription        Subscription?
  TeamMember          TeamMember[]

  @@index([userId])
}

model PricingPlan {
  id           String         @id @default(cuid())
  name         String
  type         PlanType       @unique
  monthlyPrice Float
  yearlyPrice  Float?
  apiLimit     Int
  maxApps      Int
  overagePrice Float
  features     String
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  Subscription Subscription[]

  @@index([type])
}

model Referral {
  id                String         @id @default(cuid())
  campaignId        String
  referralCode      String         @unique
  referrerId        String
  refereeId         String?
  status            ReferralStatus @default(PENDING)
  clickedAt         DateTime?
  convertedAt       DateTime?
  rewardAmount      Float?
  level             Int            @default(1)
  parentReferralId  String?
  ipAddress         String?
  isFlagged         Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  country           String?
  deviceFingerprint String?
  flaggedAt         DateTime?
  flaggedBy         String?
  userAgent         String?
  Conversion        Conversion[]
  Campaign          Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  Referral          Referral?      @relation("ReferralToReferral", fields: [parentReferralId], references: [id])
  other_Referral    Referral[]     @relation("ReferralToReferral")

  @@index([campaignId])
  @@index([deviceFingerprint])
  @@index([ipAddress])
  @@index([parentReferralId])
  @@index([refereeId])
  @@index([referralCode])
  @@index([referrerId])
  @@index([status, campaignId])
  @@index([status])
}

model Subscription {
  id                   String             @id @default(cuid())
  partnerId            String             @unique
  planId               String
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  stripeCustomerId     String?
  stripeSubscriptionId String?
  cancelAtPeriodEnd    Boolean            @default(false)
  trialEndsAt          DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  Partner              Partner            @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  PricingPlan          PricingPlan        @relation(fields: [planId], references: [id])

  @@index([partnerId])
  @@index([planId])
  @@index([status])
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String
  message   String
  source    String?
  metadata  String?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([level])
  @@index([source])
}

model TeamMember {
  id               String    @id @default(cuid())
  partnerId        String
  email            String
  name             String?
  role             TeamRole
  inviteToken      String?   @unique
  inviteAcceptedAt DateTime?
  lastLoginAt      DateTime?
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  Partner          Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, email])
  @@index([email])
  @@index([partnerId])
}

model User {
  id                  String         @id @default(cuid())
  email               String         @unique
  password            String
  role                UserRole
  name                String?
  active              Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  emailVerified       Boolean        @default(false)
  emailVerifyExpiry   DateTime?
  emailVerifyToken    String?
  passwordResetExpiry DateTime?
  passwordResetToken  String?
  Notification        Notification[]
  Partner             Partner[]

  @@index([emailVerifyToken])
  @@index([email])
  @@index([passwordResetToken])
  @@index([role])
}

model Webhook {
  id              String            @id @default(cuid())
  appId           String
  url             String
  secret          String
  events          String
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  App             App               @relation(fields: [appId], references: [id], onDelete: Cascade)
  WebhookDelivery WebhookDelivery[]

  @@index([appId])
}

model WebhookDelivery {
  id          String           @id @default(cuid())
  webhookId   String
  eventType   WebhookEventType
  payload     String
  response    String?
  statusCode  Int?
  success     Boolean          @default(false)
  retryCount  Int              @default(0)
  nextRetryAt DateTime?
  createdAt   DateTime         @default(now())
  Webhook     Webhook          @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([nextRetryAt])
  @@index([success])
  @@index([webhookId])
}

enum AppStatus {
  ACTIVE
  SUSPENDED
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  SCHEDULED
  EXPIRED
}

enum FraudType {
  DUPLICATE_IP
  SELF_REFERRAL
  RATE_LIMIT_EXCEEDED
  SUSPICIOUS_PATTERN
  VELOCITY_CHECK
  DEVICE_FINGERPRINT
  MANUAL_FLAG
  VPN_PROXY_DETECTED
  IMPOSSIBLE_CONVERSION_TIME
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

enum NotificationType {
  REFERRAL_CONVERTED
  REFERRAL_CODE_GENERATED
  TEAM_INVITE_ACCEPTED
  CUSTOM_ADMIN
  FRAUD_ALERT
}

enum PlanType {
  FREE
  GROWTH
  PRO
  ENTERPRISE
}

enum ReferralStatus {
  PENDING
  CLICKED
  CONVERTED
  EXPIRED
  FLAGGED
}

enum ReferralType {
  ONE_SIDED
  TWO_SIDED
  MULTI_LEVEL
}

enum RewardModel {
  FIXED_CURRENCY
  PERCENTAGE
  TIERED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum TeamRole {
  ADMIN
  ANALYST
  DEVELOPER
}

enum UserRole {
  SUPER_ADMIN
  PARTNER
}

enum WebhookEventType {
  REFERRAL_CREATED
  REFERRAL_CLICKED
  REFERRAL_CONVERTED
  REWARD_CREATED
  USAGE_LIMIT_EXCEEDED
}

model ContactInquiry {
  id        String   @id @default(cuid())
  name      String
  email     String
  company   String?
  subject   String?
  message   String
  status    InquiryStatus @default(NEW)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

enum InquiryStatus {
  NEW
  READ
  REPLIED
}

model Changelog {
  id          String   @id @default(cuid())
  version     String
  type        ChangelogType
  title       String
  content     String
  status      ChangelogStatus @default(DRAFT)
  releaseDate DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([version])
}

enum ChangelogType {
  MAJOR
  MINOR
  PATCH
}

enum ChangelogStatus {
  DRAFT
  PUBLISHED
}

model Blog {
  id        String     @id @default(cuid())
  title     String
  slug      String     @unique
  author    String
  content   String
  category  String
  status    BlogStatus @default(DRAFT)
  publishedAt DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([status])
  @@index([slug])
}

enum BlogStatus {
  DRAFT
  PUBLISHED
}
